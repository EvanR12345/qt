<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diuretics Med Chem — Interactive Quiz (Instant Feedback)</title>
  <style>
    :root { --bg:#fff; --text:#111; --muted:#666; --border:#ddd; --ok:#0a7a2f; --bad:#b00020; }
    html,body{background:var(--bg); color:var(--text); margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;}
    .wrap{max-width:980px; margin:28px auto; padding:0 16px 40px;}
    h1{font-size:22px; margin:0 0 8px;}
    .sub{color:var(--muted); margin:0 0 18px; line-height:1.4;}
    .toolbar{display:flex; flex-wrap:wrap; gap:10px; align-items:center; padding:12px; border:1px solid var(--border); border-radius:12px; margin:16px 0 18px;}
    .toolbar > *{margin:0;}
    button{cursor:pointer; border:1px solid var(--border); background:#f7f7f7; padding:10px 12px; border-radius:10px; font-weight:600;}
    button:hover{background:#efefef;}
    .pill{padding:8px 10px; border:1px solid var(--border); border-radius:999px; background:#fafafa; font-size:13px;}
    .q{border:1px solid var(--border); border-radius:14px; padding:14px 14px 10px; margin:12px 0; background:#fff;}
    .qhead{display:flex; gap:10px; align-items:flex-start; justify-content:space-between;}
    .qtitle{font-weight:800; font-size:14px; margin:0;}
    .tag{font-size:12px; color:var(--muted); border:1px solid var(--border); padding:4px 8px; border-radius:999px; white-space:nowrap;}
    .prompt{margin:10px 0 12px; line-height:1.4;}
    .opts{display:grid; gap:8px; margin:0 0 10px;}
    label.opt{display:flex; gap:10px; align-items:flex-start; border:1px solid var(--border); border-radius:12px; padding:10px; cursor:pointer;}
    label.opt:hover{background:#fafafa;}
    input[type="radio"]{margin-top:2px;}
    .feedback{margin:10px 0 6px; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#fafafa; display:none;}
    .feedback.ok{border-color:rgba(10,122,47,.35); background:rgba(10,122,47,.08); color:var(--ok);}
    .feedback.bad{border-color:rgba(176,0,32,.35); background:rgba(176,0,32,.08); color:var(--bad);}
    .explain{color:var(--text); margin-top:6px; font-size:13px; line-height:1.35;}
    .explain .muted{color:var(--muted);}
    .small{font-size:12px; color:var(--muted);}
    .status-ok{color:var(--ok);}
    .status-error{color:var(--bad);}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
         font-size:12px; padding:2px 6px; border:1px solid var(--border); border-radius:6px; background:#fff;}
    .scorebar{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    progress{width:220px; height:12px;}
    .divider{height:1px; background:var(--border); margin:10px 0;}
    .note{font-size:13px; color:var(--muted); margin-top:8px;}
    .settings-panel{display:none; margin:0 0 16px; padding:12px; border:1px solid var(--border); border-radius:12px; background:#fcfcfc;}
    .settings-panel.open{display:block;}
    .settings-title{font-weight:700; margin:0 0 10px;}
    .setting{display:flex; align-items:center; gap:8px; margin:8px 0; font-size:14px;}
    .settings-panel textarea{width:100%; min-height:150px; resize:vertical; border:1px solid var(--border); border-radius:10px; padding:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; box-sizing:border-box;}
    .settings-actions{display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap;}
    .compact .q{padding:10px 10px 8px; margin:8px 0;}
    .compact .prompt{margin:6px 0 8px;}
    .compact .opts{gap:6px;}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Diuretics Med Chem — Interactive Quiz</h1>
    <p class="sub">
      This is a foramt for future pratice questions<br>
      <span class="small">Instant feedback • White background • Click an option to answer.</span>
    </p>

    <div class="toolbar">
      <div class="scorebar">
        <span class="pill"><strong>Score:</strong> <span id="score">0</span>/<span id="total">0</span></span>
        <span class="pill"><strong>Answered:</strong> <span id="answered">0</span>/<span id="total2">0</span></span>
        <progress id="prog" value="0" max="1"></progress>
      </div>
      <button id="shuffleBtn" type="button">Shuffle Questions</button>
      <button id="resetBtn" type="button">Reset Answers</button>
      <button id="settingsBtn" type="button" aria-expanded="false" aria-controls="settingsPanel">Settings</button>
      <span class="pill">Tip: press <span class="kbd">Ctrl</span> + <span class="kbd">F</span> to find keywords</span>
    </div>

    <div id="settingsPanel" class="settings-panel" aria-live="polite">
      <p class="settings-title">Quiz Settings</p>
      <label class="setting">
        <input id="showExplanationsToggle" type="checkbox" checked />
        Show explanations after answering
      </label>
      <label class="setting">
        <input id="shuffleOnResetToggle" type="checkbox" />
        Shuffle questions when resetting answers
      </label>
      <label class="setting">
        <input id="compactModeToggle" type="checkbox" />
        Use compact question cards
      </label>
      <label class="setting">
        <input id="shuffleOptionsToggle" type="checkbox" />
        Swap/shuffle answer options for each question
      </label>

      <p class="settings-title" style="margin-top:12px;">Load Questions from HTML</p>
      <textarea id="questionsHtmlInput" placeholder="Paste HTML using this format:
<article data-question data-topic=&quot;chem&quot; data-answer=&quot;1&quot; data-explain=&quot;Because...&quot;>
  <h3>Which option is correct?</h3>
  <ul>
    <li>Option A</li>
    <li>Option B</li>
    <li>Option C</li>
  </ul>
</article>"></textarea>
      <div class="settings-actions">
        <button id="loadQuestionsHtmlBtn" type="button">Load HTML Questions</button>
        <button id="copyPromptBtn" type="button">in put promt in chat</button>
        <span id="htmlLoadStatus" class="small"></span>
      </div>
    </div>

    <div id="quiz"></div>
    <p class="note">Notes here</p>
  </div>

  <script>
    let questionsBank = [
      {
        topic: "question",
        q: "Question 1",
        choices: ["A", "B", "C", "D"],
        answer: 0,
        explain: "Potency = dose/amount needed for a given response. Efficacy = the maximum effect."
      }
    ];

    let state = {
      order: [],
      answers: {},
      locked: {},
      score: 0,
      answered: 0,
      choiceOrder: {},
      settings: {
        showExplanations: true,
        shuffleOnReset: false,
        compactMode: false,
        shuffleOptions: false
      }
    };


    const MAX_HTML_INPUT_LENGTH = 100000;
    const MAX_QUESTIONS = 200;
    const MAX_CHOICES_PER_QUESTION = 20;
    const MAX_TEXT_LENGTH = 500;
    const FORBIDDEN_TAGS = new Set(["script", "iframe", "object", "embed", "link", "style", "meta", "base", "form"]);
    const FORBIDDEN_ATTR_PREFIXES = ["on"];
    const FORBIDDEN_ATTR_NAMES = new Set(["srcdoc"]);

    function setStatus(message, isError = false) {
      const status = document.getElementById("htmlLoadStatus");
      status.textContent = message;
      status.classList.toggle("status-error", isError);
      status.classList.toggle("status-ok", !isError);
    }

    function clampText(text, maxLen = MAX_TEXT_LENGTH) {
      const clean = String(text || "").replace(/\s+/g, " ").trim();
      return clean.length > maxLen ? `${clean.slice(0, maxLen)}…` : clean;
    }

    function validateSafeHtmlTree(root) {
      const all = root.querySelectorAll("*");
      all.forEach((el) => {
        const tag = el.tagName.toLowerCase();
        if (FORBIDDEN_TAGS.has(tag)) {
          throw new Error(`Forbidden tag detected: <${tag}>`);
        }

        for (const attr of Array.from(el.attributes)) {
          const name = attr.name.toLowerCase();
          const value = attr.value.trim().toLowerCase();
          if (FORBIDDEN_ATTR_PREFIXES.some(prefix => name.startsWith(prefix))) {
            throw new Error(`Forbidden attribute detected: ${attr.name}`);
          }
          if (FORBIDDEN_ATTR_NAMES.has(name)) {
            throw new Error(`Forbidden attribute detected: ${attr.name}`);
          }
          if ((name === "href" || name === "src") && value.startsWith("javascript:")) {
            throw new Error(`Forbidden URL detected in ${attr.name}`);
          }
        }
      });
    }

    function parseHtmlInSandboxedDocument(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");
      validateSafeHtmlTree(doc.body);
      return doc.body;
    }

    function initOrder() {
      state.order = questionsBank.map((_, i) => i);
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function getChoiceOrder(qid, totalChoices) {
      if (!state.settings.shuffleOptions) {
        return Array.from({ length: totalChoices }, (_, i) => i);
      }

      if (!state.choiceOrder[qid] || state.choiceOrder[qid].length !== totalChoices) {
        const idx = Array.from({ length: totalChoices }, (_, i) => i);
        shuffle(idx);
        state.choiceOrder[qid] = idx;
      }

      return state.choiceOrder[qid];
    }

    function render() {
      const quiz = document.getElementById("quiz");
      quiz.innerHTML = "";

      const total = questionsBank.length;
      document.getElementById("total").textContent = total;
      document.getElementById("total2").textContent = total;

      state.order.forEach((qid, idx) => {
        const item = questionsBank[qid];
        const qDiv = document.createElement("div");
        qDiv.className = "q";
        qDiv.dataset.qid = qid;

        const head = document.createElement("div");
        head.className = "qhead";

        const left = document.createElement("div");
        const title = document.createElement("p");
        title.className = "qtitle";
        title.textContent = `Q${idx + 1}. ${item.q}`;
        left.appendChild(title);

        const tag = document.createElement("span");
        tag.className = "tag";
        tag.textContent = item.topic;

        head.appendChild(left);
        head.appendChild(tag);

        const prompt = document.createElement("div");
        prompt.className = "prompt";
        prompt.innerHTML = "";

        const opts = document.createElement("div");
        opts.className = "opts";

        const choiceOrder = getChoiceOrder(qid, item.choices.length);
        choiceOrder.forEach((originalChoiceIdx) => {
          const lab = document.createElement("label");
          lab.className = "opt";
          const radio = document.createElement("input");
          radio.type = "radio";
          radio.name = `q_${qid}`;
          radio.value = originalChoiceIdx;
          radio.disabled = !!state.locked[qid];

          if (state.answers[qid] === originalChoiceIdx) radio.checked = true;

          radio.addEventListener("change", () => onAnswer(qid, originalChoiceIdx));

          const span = document.createElement("span");
          span.textContent = item.choices[originalChoiceIdx];

          lab.appendChild(radio);
          lab.appendChild(span);
          opts.appendChild(lab);
        });

        const fb = document.createElement("div");
        fb.className = "feedback";
        fb.id = `fb_${qid}`;

        const explain = document.createElement("div");
        explain.className = "explain";
        explain.id = `ex_${qid}`;

        qDiv.appendChild(head);
        qDiv.appendChild(prompt);
        qDiv.appendChild(opts);
        qDiv.appendChild(fb);
        qDiv.appendChild(explain);

        quiz.appendChild(qDiv);
      });

      updateScoreUI();
      document.body.classList.toggle("compact", state.settings.compactMode);
      for (const qidStr of Object.keys(state.locked)) {
        showFeedback(Number(qidStr));
      }
    }

    function onAnswer(qid, choiceIdx) {
      if (state.locked[qid]) return;

      state.answers[qid] = choiceIdx;
      state.locked[qid] = true;
      state.answered += 1;

      const correct = (choiceIdx === questionsBank[qid].answer);
      if (correct) state.score += 1;

      showFeedback(qid);
      updateScoreUI();
      document.querySelectorAll(`input[name="q_${qid}"]`).forEach(r => r.disabled = true);
    }

    function showFeedback(qid) {
      const item = questionsBank[qid];
      const fb = document.getElementById(`fb_${qid}`);
      const ex = document.getElementById(`ex_${qid}`);
      const chosen = state.answers[qid];

      const isCorrect = chosen === item.answer;
      fb.style.display = "block";
      fb.classList.remove("ok", "bad");
      fb.classList.add(isCorrect ? "ok" : "bad");

      const chosenText = (chosen != null) ? item.choices[chosen] : "—";
      const correctText = item.choices[item.answer];

      fb.textContent = isCorrect ? "✅ Correct" : "❌ Incorrect";
      if (state.settings.showExplanations) {
        ex.style.display = "block";
        ex.innerHTML = `
          <div><span class="muted">Your answer:</span> <strong>${escapeHtml(chosenText)}</strong></div>
          ${isCorrect ? "" : `<div><span class="muted">Correct answer:</span> <strong>${escapeHtml(correctText)}</strong></div>`}
          <div class="divider"></div>
          <div>${escapeHtml(item.explain || "")}</div>
        `;
      } else {
        ex.style.display = "none";
        ex.innerHTML = "";
      }
    }

    function updateScoreUI() {
      const total = questionsBank.length;
      document.getElementById("score").textContent = state.score;
      document.getElementById("answered").textContent = state.answered;
      const prog = document.getElementById("prog");
      prog.max = Math.max(total, 1);
      prog.value = state.answered;
    }

    function resetAll() {
      if (state.settings.shuffleOnReset) {
        initOrder();
        shuffle(state.order);
      }
      state.answers = {};
      state.locked = {};
      state.score = 0;
      state.answered = 0;
      state.choiceOrder = {};
      render();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function loadQuestionsFromHtml(html) {
      if (typeof html !== "string") {
        throw new Error("HTML input must be text.");
      }
      if (html.length === 0) {
        throw new Error("HTML input is empty.");
      }
      if (html.length > MAX_HTML_INPUT_LENGTH) {
        throw new Error(`HTML input is too large. Max ${MAX_HTML_INPUT_LENGTH} characters.`);
      }

      const safeRoot = parseHtmlInSandboxedDocument(html);
      const blocks = Array.from(safeRoot.querySelectorAll("[data-question]"));
      if (!blocks.length) {
        throw new Error("No question blocks found. Add elements with data-question attribute.");
      }
      if (blocks.length > MAX_QUESTIONS) {
        throw new Error(`Too many questions. Max ${MAX_QUESTIONS}.`);
      }

      const parsed = blocks.map((block, idx) => {
        const topic = clampText(block.getAttribute("data-topic") || "custom", 80);
        const answer = Number(block.getAttribute("data-answer"));
        const explain = clampText(block.getAttribute("data-explain") || "No explanation provided.");

        const qNode = block.querySelector("[data-q], h1, h2, h3, h4, p, div, span");
        const qText = clampText((qNode ? qNode.textContent : "") || `Question ${idx + 1}`);

        const choices = Array.from(block.querySelectorAll("li, [data-choice]"))
          .map(el => clampText(el.textContent || ""))
          .filter(Boolean);

        if (choices.length < 2) {
          throw new Error(`Question ${idx + 1} must have at least 2 choices.`);
        }
        if (choices.length > MAX_CHOICES_PER_QUESTION) {
          throw new Error(`Question ${idx + 1} has too many choices. Max ${MAX_CHOICES_PER_QUESTION}.`);
        }
        if (!Number.isInteger(answer) || answer < 0 || answer >= choices.length) {
          throw new Error(`Question ${idx + 1} has invalid data-answer index.`);
        }

        return { topic, q: qText, choices, answer, explain };
      });

      questionsBank = parsed;
      initOrder();
      resetAll();
    }

    document.getElementById("resetBtn").addEventListener("click", resetAll);
    document.getElementById("shuffleBtn").addEventListener("click", () => {
      initOrder();
      shuffle(state.order);
      resetAll();
    });

    const settingsBtn = document.getElementById("settingsBtn");
    const settingsPanel = document.getElementById("settingsPanel");
    settingsBtn.addEventListener("click", () => {
      settingsPanel.classList.toggle("open");
      const isOpen = settingsPanel.classList.contains("open");
      settingsBtn.setAttribute("aria-expanded", String(isOpen));
    });

    document.getElementById("showExplanationsToggle").addEventListener("change", (event) => {
      state.settings.showExplanations = event.target.checked;
      render();
    });

    document.getElementById("shuffleOnResetToggle").addEventListener("change", (event) => {
      state.settings.shuffleOnReset = event.target.checked;
    });

    document.getElementById("compactModeToggle").addEventListener("change", (event) => {
      state.settings.compactMode = event.target.checked;
      render();
    });

    document.getElementById("shuffleOptionsToggle").addEventListener("change", (event) => {
      state.settings.shuffleOptions = event.target.checked;
      state.choiceOrder = {};
      render();
    });

    document.getElementById("loadQuestionsHtmlBtn").addEventListener("click", () => {
      const html = document.getElementById("questionsHtmlInput").value;
      try {
        loadQuestionsFromHtml(html);
        setStatus(`Loaded ${questionsBank.length} question(s).`);
      } catch (err) {
        setStatus(`Unable to load HTML: ${err.message}`, true);
      }
    });

    <script>
const clipboardPrompt = `Convert my questions into the exact HTML format below.

Rules
- Output ONLY HTML
- Use this exact structure
- Keep all wording and option order exactly the same
- data-answer must be zero based index (first option = 0, second = 1, etc.)
- Support any number of options

Format

<article data-question data-topic="chem" data-answer="0" data-explain="Because...">
  <h3>Question text</h3>
  <ul>
    <li>Option 1</li>
    <li>Option 2</li>
    <li>Option 3</li>
  </ul>
</article>`;
</script>

<pre id="promptPreview"></pre>

<button id="selectBtn" type="button">Select text for manual Ctrl+C</button>

<script>
  const preview = document.getElementById("promptPreview");
  preview.textContent = clipboardPrompt;

  document.getElementById("selectBtn").addEventListener("click", () => {
    const range = document.createRange();
    range.selectNodeContents(preview);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
  });
</script>
